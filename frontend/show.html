<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cliente</title>
    <link rel="stylesheet" href="index.css" />
    <style>
      #contactList {
        list-style: none;
        padding: 0;
      }
      .contatoDiv {
        display: flex;
        gap: 30px;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="menuDiv">
        <a href="index.html">Voltar</a>
        <div>
          <a id="editLink">Editar</a>
          <button class="deleteLink" onclick="deleteClient()">Excluir</button>
        </div>
      </div>

      <h1 id="name"></h1>
      <div style="display: flex; gap: 10px">
        <p id="cpf"></p>
        <p id="birthDate"></p>
      </div>
      <p id="address"></p>
      <h2>Contatos</h2>
      <a id="newContactLink" class="button-primary">Novo contato</a>
      <ul id="contactList"></ul>
    </main>
  </body>
  <script>
    const params = new URLSearchParams(window.location.search);
    const clientId = params.get("id");

    const editLink = document.getElementById("editLink");
    editLink.href = `edit.html?id=${clientId}`;

    const contactLink = document.getElementById("newContactLink");
    contactLink.href = `contatos/new.html?id=${clientId}`;

    fetch(`http://localhost:8080/clientes/${clientId}`)
      .then((response) => {
        if (!response.ok) {
          throw new Error("Erro ao buscar os dados " + response.status);
        }
        return response.json();
      })
      .then((data) => {
        renderClient(data);
      });

    function renderClient(data) {
      console.log(data);
      const name = document.getElementById("name");
      const cpf = document.getElementById("cpf");
      const birthDate = document.getElementById("birthDate");
      const address = document.getElementById("address");
      const contactsList = document.getElementById("contactList");

      name.innerText = data.nome;
      cpf.innerText = data.cpf;
      birthDate.innerText = data.formattedBirthDate;
      address.innerText = data.endereco;

      data.contatos.forEach((contato) => {
        let li = document.createElement("li");
        li.innerHTML = `<div>
            <div class="contatoDiv">
                <p>${contato.tipo} ${contato.valor}</p>
                <div>
                    <a href="contatos/edit.html?id=${clientId}&contatoId=${contato.id}">Editar</a>
                    <button class="deleteLink" onclick="deleteContato(${contato.id})">Excluir</button>
                </div>
            </div>
        </div>`;
        contactsList.appendChild(li);
      });
    }

    function deleteClient() {
      const confirmDelete = confirm(
        `Tem certeza que deseja excluir esse cliente?`
      );
      if (!confirmDelete) return;

      fetch(`http://localhost:8080/clientes/remove/${clientId}`, {
        method: "DELETE",
      }).then((response) => {
        if (response.status == 204) {
          window.location.href = "index.html";
        }
      });
    }

    function deleteContato(contatoId) {
      const confirmDelete = confirm(
        `Tem certeza que deseja excluir esse contato?`
      );
      if (!confirmDelete) return;

      fetch(`http://localhost:8080/contatos/remove/${contatoId}`, {
        method: "DELETE",
      }).then((response) => {
        if (response.status == 204) {
          window.location.href = `show.html?id=${clientId}`;
        }
      });
    }
  </script>
</html>
